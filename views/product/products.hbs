<style>
  div,
  ::after,
  ::before {
    box-sizing: border-box;
    z-index: 100;
  }
</style>

<!-- Breadcrumbs -->
<section class="bg-gray-7">
  <div class="breadcrumbs-custom box-transform-wrap context-dark">
    <div class="container">
      <h3 class="breadcrumbs-custom-title">Menu</h3>
      <div class="breadcrumbs-custom-decor"></div>
    </div>
    <div class="box-transform" style="background-image: url(images/bg-1.jpg);"></div>
  </div>
  <div class="container">
    <ul class="breadcrumbs-custom-path">
      <li><a href="index.html">Home</a></li>
      <li class="active">Menu</li>
    </ul>
  </div>
</section>




<!-- Our Shop-->

<section class="section section-lg bg-default" id='category'>
  <div class="container">
    <div class="tabs-custom row row-50 justify-content-center flex-lg-row-reverse text-center text-md-left">
      <div class="col-lg-4 col-xl-3">
        <h5 class="text-spacing-200 text-capitalize">CATEGORY</h5>
        <ul class="nav list-category list-category-down-md-inline-block">
          <li class="list-category-item wow fadeInRight" role="presentation" data-wow-delay="0s"><a class="active"
              href="#tabs-4-1" data-toggle="tab">All products</a></li>
          <li class="list-category-item wow fadeInRight" role="presentation" data-wow-delay=".1s"><a href="#tabs-4-2"
              data-toggle="tab">Combos</a></li>
          <li class="list-category-item wow fadeInRight" role="presentation" data-wow-delay=".2s"><a href="#tabs-4-3"
              data-toggle="tab">Pizzas</a></li>
          <li class="list-category-item wow fadeInRight" role="presentation" data-wow-delay=".3s"><a href="#tabs-4-4"
              data-toggle="tab">Burgers</a></li>
          <li class="list-category-item wow fadeInRight" role="presentation" data-wow-delay=".4s"><a href="#tabs-4-5"
              data-toggle="tab">Spaghetti</a></li>
          <li class="list-category-item wow fadeInRight" role="presentation" data-wow-delay=".5s"><a href="#tabs-4-6"
              data-toggle="tab">Drinks</a></li>
          <li class="list-category-item wow fadeInRight" role="presentation" data-wow-delay=".6s"><a href="#tabs-4-7"
              data-toggle="tab">Desserts</a></li>
      </div>
      <div class="col-lg-8 col-xl-9">
        <form style="background-color: cyan;" class="position-relative " id="form-search" action="./search">
          <div class="input-group">
            <input type="text" class="form-control" onfocus="funcSearch(this)" onkeyup="funcSearch(this)"
              placeholder="Search ..." name="q" autocomplete="off" />
            <div class="input-group-append">
              <button type="submit" class="btn-primary btn"><i class="fa fa-search"></i></button>
            </div>
          </div>
          <div class="input-group mb-3 position-absolute shadow-sm  mb-5 bg-white rounded text-start"
            style="background-color: #e5f5f9; z-index: 1000 ">
            <ul id="search">

            </ul>
          </div>
        </form>
        <div class="mt-2 d-flex justify-content-start">
          <div>
            <a href="#demo" class="btn btn-light" data-toggle="collapse"> <i class="fa fa-filter"
                style="font-style: normal" aria-hidden="true"></i> Filter</a>
            <div id="demo" class="collapse  mt-2">
              <div class="form-group d-inline">
                <select class="custom-select" id="filter-price" name="filter-price">
                  <option selected="" value="0">Price</option>
                  <option value="1">5$ - 25$</option>
                  <option value="2">25$ - 45$</option>
                  <option value="3">>= 45$</option>
                </select>
              </div>
              <div class="form-group d-inline">
                <select class="custom-select" id="filter-view">
                  <option selected="" value="0">View</option>
                  <option value="1">Low</option>
                  <option value="2">Medium</option>
                  <option value="3">High</option>
                </select>
              </div>
              <div class="form-group d-inline">
                <select class="custom-select" id="filter-name">
                  <option selected="" value="0">Name</option>
                  <option value="1">From A to Z</option>
                  <option value="2">From Z to A</option>
                </select>
              </div>
            </div>
          </div>

        </div>
        <div class="row " id="list-products">

          {{#each products}}
          <div class="col-sm-6 col-lg-4 col-xl-4 my-3 ">
            <!-- Product-->
            <article class="product wow fadeInLeft" data-wow-delay=".15s">
              <div class="product-figure item"><img src="{{this.IMAGE}}" alt="" width="161" height="162" />
              </div>
              <h6 class="product-title">{{this.DISH_NAME}}</h6>
              <div class="prosduct-price-wrap">
                <div class="product-price">{{this.PRICE}}$</div>
                <div class="product-view">{{this.VIEW}}</div>
              </div>
              {{#if this.STATUS}}
              <div class="product-button">
                <div class="button-wrap add-to-cart " product-id={{this._id}}><span
                    class="button button-xs button-primary button-winona ">Add to cart</span></div>
                <div class="button-wrap"><a class="button button-xs button-secondary button-winona"
                    href="../products?id={{this._id}}">View
                    Product</a></div>
              </div>
              <span class="product-badge product-badge-sale">Sale</span>
              {{/if}}
              {{#unless this.STATUS}}
              <span class="product-badge product-badge-new">Hết Hàng</span>
              {{/unless}}
            </article>
          </div>
          {{/each}}

        </div>
        <ul class="pagination justify-content-center" id="paging">
          <li class="page-item disabled"><button class="page-link" id="prePage">Previous</button></li>
          <li class="page-item active"><button class="page-link " id="pre-Page">1</button></li>
          <li class="page-item"><button class="page-link" id="page">2</button></li>
          <li class="page-item"><button class="page-link" id='next-Page'>3</button></li>
          <li class="page-item"><button class="page-link" id="nextPage">Next</button></li>
        </ul>

      </div>

    </div>
  </div>
</section>

{{!-- Script --}}
<!-- Javascript-->
<script src="js/core.min.js"></script>
<script src="js/script.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
  $.noConflict();
  jQuery(document).ready(function ($) {
    console.log("ready!");
    let page = 1;
    let nextPage, prePage;
    //Paging
    $('.page-link').click((e) => {
      console.log('Page link');
      if (e.currentTarget.innerHTML == 'Next')
        page = page + 1;
      else if (e.currentTarget.innerHTML == 'Previous')
        page = page - 1;
      else page = parseInt(e.currentTarget.innerHTML);
      $.get("../api/products",
        {
          page: page
        },
        function (products, status) {
          $('#list-products').html(``);
          for (i in products) {
            //console.dir(products[i]);
            $('#list-products').append(` <div class="col-sm-6 col-lg-4 col-xl-4 my-3">
                <!-- Product-->
                <article class="product wow fadeInLeft" data-wow-delay=".15s">
                  <div class="product-figure item"><img src="${products[i].IMG}" alt="" width="161" height="162" />
                  </div>
                  <h6 class="product-title">${products[i].DISH_NAME}</h6>
                  <div class="product-price-wrap">
                    <div class="product-price">${products[i].PRICE}$</div>
                    <div class="product-view">${products[i].VIEW}</div>
                  </div>
                  <div class="product-button">
                    <div class="button-wrap add-to-cart" product-id="${products[i]._id}"><span class="button button-xs button-primary button-winona">Add to
                        cart</span></div>
                    <div class="button-wrap"><a class="button button-xs button-secondary button-winona" href="../products?id=${products[i]._id}">View
                        Product</a></div>
                  </div>
                </article>
              </div>`);
          }
          if ($('#filter-price').val() != 0 || $('#filter-view').val() != 0 || $('#filter-name').val() != 0)
            filter();
          $('.add-to-cart').on('click', function () {
            productId = $(this).attr("product-id");
            imgtodrag = $(this).closest('.product').find('.item').find("img").eq(0);
            console.log('img', imgtodrag);
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
              if (this.readyState == 4 && this.status == 200) {
                var cart = $('.shopping-cart');
                if (imgtodrag) {
                  var imgclone = imgtodrag.clone()
                    .offset({
                      top: imgtodrag.offset().top,
                      left: imgtodrag.offset().left
                    })
                    .css({
                      'opacity': '0.8',
                      'position': 'absolute',
                      'height': '150px',
                      'width': '150px',
                      'z-index': '100'
                    })
                    .appendTo($('body'))
                    .animate({
                      'top': cart.offset().top + 10,
                      'left': cart.offset().left + 10,
                      'width': 75,
                      'height': 75
                    }, 1000, 'easeInOutExpo');

                  imgclone.animate({
                    'width': 0,
                    'height': 0
                  }, function () {
                    $(this).detach()
                  });
                }
              }
            };
            xhttp.open("GET", `../products/add-to-cart?id=${productId}`, true);
            xhttp.send();
          });
          document.location.href = '#category';
          nextPage = page + 1;
          prePage = page - 1;
          if (prePage == 0) {
            $('#prePage').parent().addClass('disabled');
            $('#pre-Page').parent().addClass('active');
            $('#pre-Page').html(page);
            $('#page').html(nextPage);
            $('#page').parent().removeClass('active');
            $('#next-Page').html(nextPage + 1);
            $('#nextPage').parent().remove('disabled');
          } else {
            $('#prePage').parent().removeClass('disabled');
            $('#pre-Page').parent().removeClass('active');
            $('#pre-Page').html(prePage);
            $('#page').html(page);
            $('#next-Page').html(nextPage);
            $('#next-Page').parent().show();
            $('#page').parent().addClass('active');
            $('#nextPage').parent().removeClass('disabled');
          }
          $.get("../api/products",
            {
              page: nextPage
            },
            function (products, status) {
              console.log('next Page: ' + products[0]);
              if (products[0] == undefined) {
                console.log('empty ');
                $('#next-Page').parent().hide();
                $('#nextPage').parent().addClass('disabled');
              }
            });
        });
    });
    ///Add to cart
    $('.add-to-cart').on('click', function () {
      productId = $(this).attr("product-id");
      imgtodrag = $(this).closest('.product').find('.item').find("img").eq(0);
      console.log('img', imgtodrag);
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var cart = $('.shopping-cart');
          if (imgtodrag) {
            var imgclone = imgtodrag.clone()
              .offset({
                top: imgtodrag.offset().top,
                left: imgtodrag.offset().left
              })
              .css({
                'opacity': '0.8',
                'position': 'absolute',
                'height': '150px',
                'width': '150px',
                'z-index': '100'
              })
              .appendTo($('body'))
              .animate({
                'top': cart.offset().top + 10,
                'left': cart.offset().left + 10,
                'width': 75,
                'height': 75
              }, 1000, 'easeInOutExpo');

            imgclone.animate({
              'width': 0,
              'height': 0
            }, function () {
              $(this).detach()
            });
          }
        }
      };
      xhttp.open("GET", `../products/add-to-cart?id=${productId}`, true);
      xhttp.send();
    });
  });
  //Search 
  function funcSearch(s) {
    $('#search').show();
    $.get("../api/products/search",
      {
        q: s.value
      },
      function (products, status) {
        $('#search').html('');
        for (product in products) {
          //  console.log(products[product]);
          $('#search').append(`<li> <a href="../products?id=${products[product]._id}" class="ms-3">${products[product].DISH_NAME}</a></li>`);
        }
      }
    );
  }
  //Filter
  $('select').click(() => {
    filter();
  });
  function filter() {
    //Reset Display products
    let listProducts = $('#list-products').children();
    listProducts.map(i => listProducts[i].style.display = "");
    const priceValue = parseInt($('#filter-price').val());
    const viewValue = parseInt($('#filter-view').val());
    const nameValue = parseInt($('#filter-name').val());
    console.log(priceValue + " " + viewValue + " " + nameValue);
    //Filter by Price
    if (priceValue != 0) {
      filterByPrice(listProducts, priceValue);
    }
    //Filter by Name
    if (nameValue != 0) {
      filterByName(listProducts, nameValue);
    }
    //Filter by View
    if (viewValue != 0) {
      filterByView(listProducts, viewValue);
    }
    if (priceValue == 0 && viewValue == 0 && nameValue == 0) {
      $('.active .page-link').click();
    }
  }
  function filterByPrice(listProducts, value) {
    //value: 1 -> 5 -> 25 
    //value: 2 -> 25 -> 45
    //value: 3 -> 45
    let filter;
    if (value == 1) {
      filter = 5;
    } else if (value == 2) {
      filter = 25;
    } else {
      filter = 45;
    }
    listProducts.map(i => {
      let htmlPrice = listProducts[i].getElementsByClassName('product-price')[0].innerHTML;
      const price = parseInt(htmlPrice.replace('$', ''));
      if (price < filter || price > filter + 20) {
        listProducts[i].style.display = "none";
      }
    });

  }
  function filterByName(listProducts, value) {
    if (value == 1) {
      //A -> Z
      listProducts.sort((a, b) => {
        const nameA = a.getElementsByClassName('product-title')[0].innerHTML[0];
        const nameB = b.getElementsByClassName('product-title')[0].innerHTML[0];
        console.log(nameA, nameB);
        if (nameA < nameB) { return -1; }
        if (nameA > nameB) { return 1; }
        return 0;
      });
    } else {
      //Z - > A
      listProducts.sort((a, b) => {
        const nameA = a.getElementsByClassName('product-title')[0].innerHTML[0];
        const nameB = b.getElementsByClassName('product-title')[0].innerHTML[0];
        console.log(nameA, nameB);
        if (nameA < nameB) { return 1; }
        if (nameA > nameB) { return -1; }
        return 0;
      });
    }
    $('#list-products').html('');
    $('#list-products').append(listProducts);
  }
  function filterByView(listProducts, value) {
    //value: 1 -> 0 - >400
    //value: 2 -> 400 --> 800
    //value: 3 -> 800
    let filter;
    if (value == 1) {
      filter = 0;
    } else if (value == 2) {
      filter = 400;
    } else {
      filter = 800;
    }
    listProducts.map(i => {
      const price = parseInt(listProducts[i].getElementsByClassName('product-view')[0].innerHTML);
      if (price < filter || price > filter + 400) {
        listProducts[i].style.display = "none";
      }
    });
  }
 
  $('body').click(function (event) {
    if (event.target != $('#form-search')) {
      $('#search').html('');
    }
    //if(!$())
  });
</script>