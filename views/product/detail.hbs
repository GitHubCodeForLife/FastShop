<!-- Breadcrumbs -->
<section class="bg-gray-7">
  <div class="container">
    <ul class="breadcrumbs-custom-path">
      <li><a href="index.html">Home</a></li>
      <li class="active">Menu</li>
    </ul>
  </div>
</section>
<!-- Our Shop-->
<section class="section section-lg bg-default" id='category'>
  <div class="tabs-custom row row-50 justify-content-center flex-lg-row-reverse text-center text-md-left">
    <div class="col-lg-8 col-xl-9">
      <section class=" text-md-left">
        <div class="container wow fadeInLeft" data-wow-delay=".15s">
          <div class="row row-60 justify-content-center flex-lg-row">
            <!-- <div class="col-lg-6 col-xl-5"><img src="images/product1-669x669.png" alt="" width="669" height="669"/>
          </div> -->
            <div class="col-sm-6 col-lg-4 col-xl-4">
              <!-- Product-->
              <article class="product-detail ">
                {{!-- <div class="product-figure item"><img src="images/product-1-161x162.png" alt="" width="350" height="350" />
          </div> --}}

                <div id="carouselExampleIndicators" class="product-figure item carousel slide" data-ride="carousel">
                  <ol class="carousel-indicators">
                    <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                    <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
                    <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
                  </ol>
                  <div class="carousel-inner">
                    <div class="carousel-item active">
                      <img class="d-block" src="{{product.IMAGES.[0]}}" alt="First slide" width="350"
                        height="350">
                    </div>
                    <div class="carousel-item">
                      <img class="d-block" src="{{product.IMAGES.[1]}}" alt="Second slide" width="350"
                        height="350">
                    </div>
                    <div class="carousel-item">
                      <img class="d-block" src="{{product.IMAGES.[2]}}" alt="Third slide" width="350"
                        height="350">
                    </div>
                  </div>
                  <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="carousel-control-next " href="#carouselExampleIndicators" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
                </div>
                <div class="product-price-wrap">
                  <div class="product-price-detail">{{product.PRICE}}$</div>
                </div>
              </article>
            </div>
            <div class="col-md-8 col-lg-6 col-xl-7 d-flex flex-column justify-content-between">
              <!-- <div class=""> -->
              <article class="quote-modern">
                <h3 class="heading-3">{{product.DISH_NAME}}</h3>
                <div class="">
                  <p> Rating: <span class="fa fa-star fa-3 checked "></span>
                    <span class="fa fa-star fa-3 checked"></span>
                    <span class="fa fa-star fa-3 checked"></span>
                    <span class="fa fa-star fa-3"></span>
                    <span class="fa fa-star fa-3"></span>
                  </p>
                  <div>
                    <span class="fa fa-eye text-view" aria-hidden="true"></span>
                    <span class="product-view">{{product.VIEW}}</span>
                    <span class="text-view"> views</span>
                  </div>
                </div>
                <hr>
                </hr>

                <h5 class="quote-modern-text my-3"><span class="q">{{product.DESCRIPTION}}</span></h5>
                <hr>
                </hr>
              </article>

              <div class="row align-items-center justify-content-between my-0">
                <div class="col-md-12 col-lg-4 col-xl-4 my-2">
                  <div class="input-group number-spinner">
                    <span class="input-group-btn">
                      <button class="btn btn-stepper " data-dir="dwn"><span class="fa fa-minus"></span></button>
                    </span>
                    <input type="number" class="form-control text-center" value="1" id="qty"
                      onkeypress="return isNumberKey(event)">
                    <span class="input-group-btn">
                      <button class="btn btn-stepper " data-dir="up"><span class="fa fa-plus"></span></button>
                    </span>
                  </div>
                </div>
                <div class="col-md-12 col-lg-4 col-xl-4">
                  <div class="button-wrap" id="add-to-cart" product-id="{{product._id}}"><span
                      class="button button-xs button-primary button-winona">Add to
                      cart</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</section>

<!--Comments-->
<section class="section section-lg bg-gray-100 text-md-left">
  <div class="container px-5 wow fadeInLeft" data-wow-delay=".15s" id="list-comment">
    <h4 class="text-spacing-25 text-transform-none">What people think</h4>
  </div>
  <button class="btn btn-primary mb-5 mt-3" onclick="loadMoreComment()" id="more-btn">More <i class="fa fa-arrow-right"
      style="font-style: normal;" aria-hidden="true"></i></button>
  <div class="container wow fadeInLeft" data-wow-delay=".15s">
    <div class="row row-60 justify-content-center">
      <div class="col-lg-8">
        <h4 class="text-spacing-25 text-transform-none">Give a comment</h4>
        <div class="rd-form rd-mailform" data-form-output="form-output-global" data-form-type="comment" method="post">
          <div class="row row-20 gutters-20">
            {{#unless user}}
            <div class="col-md-6">
              <div class="form-wrap">
                <input class="form-input" id="comment-your-name-5" type="text" name="name" data-constraints="@Required">
                <label class="form-label" for="comment-your-name-5">Your Name*</label>
              </div>
            </div>
            {{/unless}}
            {{#if user}}
            <div class="col-md-6" style="display: none;">
              <div class="form-wrap">
                <input class="form-input" id="comment-your-name-5" type="text" name="name" value="{{user.CUS_NAME}}"
                  data-constraints="@Required">
                <label class="form-label" for="comment-your-name-5">Your Name*</label>
              </div>
            </div>
            {{/if}}
            <div class="col-12">
              <div class="form-wrap">
                <label class="form-label" for="comment-message-5">Message</label>
                <textarea class="form-input textarea-lg" id="comment-message-5" name="message"
                  data-constraints="@Required"></textarea>
              </div>
            </div>
          </div>
          <button class="button button-secondary button-winona" type="submit" onclick="postComment()">Submit</button>
        </div>
      </div>
    </div>
  </div>
</section>

{{!-- Recommend products --}}
<div class="card shadow-lg bg-white rounded" style="outline: 2px red solid;">
  <div class=" p-5">
    <p class="mb-2">WAIT! CHECK OUT THERE</p>
    <h4>PRODUCTS RECOMMEND FOR <span class="text-danger">YOU!</span></h4>
  </div>
  <div class="card-body p-5">
    <div id="demo" class="carousel slide" data-ride="carousel">
      <!-- Indicators -->
      <ul class="carousel-indicators">
        <li data-target="#demo" data-slide-to="0" class="active"></li>
        <li data-target="#demo" data-slide-to="1"></li>
        <li data-target="#demo" data-slide-to="2"></li>
      </ul>
      <div class="carousel-inner">
        <div class="carousel-item active">
          <div class="row">
            <!-- Product-->
            {{#if first}}
            {{#each first}}
            {{#if this}}
            <div class="col-sm-6 col-lg-4 col-xl-4 my-3 ">
              <!-- Product-->
              <article class="product wow fadeInLeft" data-wow-delay=".15s">
                <div class="product-figure item"><img src="{{this.IMAGES.[0]}}" alt="" width="161" height="162" />
                </div>
                <h6 class="product-title">{{this.DISH_NAME}}</h6>
                <div class="prosduct-price-wrap">
                  <div class="product-price">{{this.PRICE}}$</div>
                  <div>
                    <span class="fa fa-eye text-view" aria-hidden="true"></span>
                    <span class="product-view">{{this.VIEW}}</span>
                    <span class="text-view"> views</span>
                  </div>
                </div>
                {{#if this.STATUS}}
                <div class="product-button">
                  <div class="button-wrap add-to-cart " product-id={{this._id}}><span
                      class="button button-xs button-primary button-winona ">Add to cart</span></div>
                  <div class="button-wrap"><a class="button button-xs button-secondary button-winona"
                      href="../products/detail?id={{this._id}}">View
                      Product</a></div>
                </div>
                <span class="product-badge product-badge-sale">Sale</span>
                {{/if}}
                {{#unless this.STATUS}}
                <span class="product-badge product-badge-new">Hết Hàng</span>
                {{/unless}}
              </article>
            </div>
            {{/if}}
            {{/each}}
            {{/if}}
          </div>
        </div>
        <div class="carousel-item">
          <div class="row">
            {{#if second}}
            {{#each second}}
            {{#if this}}
            <div class="col-sm-6 col-lg-4 col-xl-4 my-3 ">
              <!-- Product-->
              <article class="product wow fadeInLeft" data-wow-delay=".15s">
                <div class="product-figure item"><img src="{{this.IMAGES.[0]}}" alt="" width="161" height="162" />
                </div>
                <h6 class="product-title">{{this.DISH_NAME}}</h6>
                <div class="prosduct-price-wrap">
                  <div class="product-price">{{this.PRICE}}$</div>
                  <div>
                    <span class="fa fa-eye text-view" aria-hidden="true"></span>
                    <span class="product-view">{{this.VIEW}}</span>
                    <span class="text-view"> views</span>
                  </div>
                </div>
                {{#if this.STATUS}}
                <div class="product-button">
                  <div class="button-wrap add-to-cart " product-id={{this._id}}><span
                      class="button button-xs button-primary button-winona ">Add to cart</span></div>
                  <div class="button-wrap"><a class="button button-xs button-secondary button-winona"
                      href="../products/detail?id={{this._id}}">View
                      Product</a></div>
                </div>
                <span class="product-badge product-badge-sale">Sale</span>
                {{/if}}
                {{#unless this.STATUS}}
                <span class="product-badge product-badge-new">Hết Hàng</span>
                {{/unless}}
              </article>
            </div>
            {{/if}}
            {{/each}}
            {{/if}}
          </div>
        </div>
        <div class="carousel-item">
          <div class="row">
            {{#if third}}
            {{#each third}}
            {{#if this}}
            <div class="col-sm-6 col-lg-4 col-xl-4 my-3 ">
              <!-- Product-->
              <article class="product wow fadeInLeft" data-wow-delay=".15s">
                <div class="product-figure item"><img src="{{this.IMAGES.[0]}}" alt="" width="161" height="162" />
                </div>
                <h6 class="product-title">{{this.DISH_NAME}}</h6>
                <div class="prosduct-price-wrap">
                  <div class="product-price">{{this.PRICE}}$</div>
                  <div>
                    <span class="fa fa-eye text-view" aria-hidden="true"></span>
                    <span class="product-view">{{this.VIEW}}</span>
                    <span class="text-view"> views</span>
                  </div>
                </div>
                {{#if this.STATUS}}
                <div class="product-button">
                  <div class="button-wrap add-to-cart " product-id={{this._id}}><span
                      class="button button-xs button-primary button-winona ">Add to cart</span></div>
                  <div class="button-wrap"><a class="button button-xs button-secondary button-winona"
                      href="../products/detail?id={{this._id}}">View
                      Product</a></div>
                </div>
                <span class="product-badge product-badge-sale">Sale</span>
                {{/if}}
                {{#unless this.STATUS}}
                <span class="product-badge product-badge-new">Hết Hàng</span>
                {{/unless}}
              </article>
            </div>
            {{/if}}
            {{/each}}
            {{/if}}
          </div>
        </div>
      </div>
      <!-- Left and right controls -->
      <a class="carousel-control-prev" href="#demo" data-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </a>
      <a class="carousel-control-next" href="#demo" data-slide="next">
        <span class="carousel-control-next-icon"></span>
      </a>
    </div>
  </div>
</div>
<!-- Global Mailform Output-->
<div class="snackbars" id="form-output-global"></div>
<!-- Javascript-->

<script src="https://code.jquery.com/jquery-3.2.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
  $.noConflict();
  jQuery(document).ready(function ($) {
    // Code that uses jQuery's $ can follow here.
    productId = $('#add-to-cart').attr("product-id");
    $('#add-to-cart').on('click', function () {
      var qty = $('#qty').val();
      console.log(qty);
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var cart = $('.shopping-cart');
          var imgtodrag = $('.carousel-item.active').find("img").eq(0);
          console.log(imgtodrag);
          if (imgtodrag) {
            var imgclone = imgtodrag.clone()
              .offset({
                top: imgtodrag.offset().top,
                left: imgtodrag.offset().left
              })
              .css({
                'opacity': '0.8',
                'position': 'absolute',
                'height': '150px',
                'width': '150px',
                'z-index': '100'
              })
              .appendTo($('body'))
              .animate({
                'top': cart.offset().top + 10,
                'left': cart.offset().left + 10,
                'width': 75,
                'height': 75
              }, 1000, 'easeInOutExpo');


            imgclone.animate({
              'width': 0,
              'height': 0
            }, function () {
              $(this).detach()
            });
          }
        }
      };
      xhttp.open("GET", `../products/add-to-cart?id=${productId}&qty=${qty}`, true);
      xhttp.send();
    });
    ///Add to cart
    $('.add-to-cart').on('click', config);
    function config() {
      productId = $(this).attr("product-id");
      imgtodrag = $(this).closest('.product').find('.item').find("img").eq(0);
      console.log('img', imgtodrag);
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var cart = $('.shopping-cart');
          if (imgtodrag) {
            var imgclone = imgtodrag.clone()
              .offset({
                top: imgtodrag.offset().top,
                left: imgtodrag.offset().left
              })
              .css({
                'opacity': '0.8',
                'position': 'absolute',
                'height': '150px',
                'width': '150px',
                'z-index': '100'
              })
              .appendTo($('body'))
              .animate({
                'top': cart.offset().top + 10,
                'left': cart.offset().left + 10,
                'width': 75,
                'height': 75
              }, 1000, 'easeInOutExpo');
            imgclone.animate({
              'width': 0,
              'height': 0
            }, function () {
              $(this).detach()
            });
          }
        }
      };
      xhttp.open("GET", `../products/add-to-cart?id=${productId}`, true);
      xhttp.send();
    };

  });
// Code that uses other library's $ can follow here.
</script>
<script src="js/core.min.js"></script>
<script src="js/script.js"></script>
<script>
  function isNumberKey(evt) {
    var charCode = (evt.which) ? evt.which : evt.keyCode
    if (charCode > 31 && (charCode < 48 || charCode > 57))
      return false;
    return true;
  }

  $(document).on('click', '.number-spinner button', function () {
    var a = $(this),
      oldValue = a.closest('.number-spinner').find('input').val().trim(),
      newVal = 0;
    if (a.attr('data-dir') == 'up') {
      newVal = parseInt(oldValue) + 1;
    } else {
      if (oldValue > 1) {
        newVal = parseInt(oldValue) - 1;
      } else {
        newVal = 1;
      }
    }
    a.closest('.number-spinner').find('input').val(newVal);
  });
  const url_string = window.location.href;
  const url = new URL(url_string);
  const id = url.searchParams.get("id");
  console.log(id);
  let page = 1;

  //Load comment user AJA
  $.get(`../../api/products/comments/${id}`,
    {
      page: page
    },
    function (data, status) {
      if (data[0] == undefined) {
        $('#more-btn').remove();
        $('#list-comment').append(`<div id="no-comment">This product do not have any comments</div>`);
      }
      for (i in data) {
        $('#list-comment').append(` <div class="row">
                          <div class="col-2">
                            <article class="comment-profile">
                              <div class="comment-picture">
                                <img src="images/comment-100x100.png" alt="" width="80" height="80" />
                              </div>
                              <div class="comment-name">
                                <p>${data[i].REVIEWER}</p>
                              </div>
                            </article>
                          </div>
                          <div class="col-10">
                            <div class="speech-bubble">
                              ${data[i].CONTENT}
                            </div>
                          </div>
                        </div> `)
      }
    });
  //Post comment on API
  function postComment() {
    const name = $('#comment-your-name-5').val();
    const message = $('#comment-message-5').val();
    console.log(name, message);
    if (name == '' || message == '') {
      alert('Please fill all information of form');
      return;
    }
    //Push comment on database
    $.post(`/api/products/comments/${id}`,
      {
        name: name,
        message: message
      },
      function (data, status) {
        console.log('Data res: ', data);
        $('#no-comment').remove();
        //Clear text area
        $('#comment-message-5').val('');
        //View 
        $('#list-comment').append(` <div class="row">
                  <div class="col-2">
                    <article class="comment-profile">
                      <div class="comment-picture">
                      <img src="images/face-0.png" alt="" width="80" height="80" />
                      </div>
                      <div class="comment-name">
                        <p>${name}</p>
                      </div>
                    </article>
                  </div>
                  <div class="col-10">
                    <div class="speech-bubble">
                      ${message}
                    </div>
                  </div>
                </div> `);
      });

  }
  //Load more comment
  function loadMoreComment() {
    $.get(`/api/products/comments/${id}`,
      {
        page: ++page
      },
      function (data, status) {
        if (data[0] == undefined) {
          $('#more-btn').remove();
        }
        for (i in data) {
          $('#list-comment').append(` <div class="row">
          <div class="col-2">
            <article class="comment-profile">
              <div class="comment-picture">
                <img src="images/comment-100x100.png" alt="" width="80" height="80" />
              </div>
              <div class="comment-name">
                <p>${data[i].REVIEWER}</p>
              </div>
            </article>
          </div>
          <div class="col-10">
            <div class="speech-bubble">
              ${data[i].CONTENT}
            </div>
          </div>
        </div> `)
        }
      });
  }
</script>